<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Oracle by J√©j√® ‚Äî Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --bg:#050712;
      --panel: rgba(12, 14, 30, 0.92);
      --border: rgba(255,255,255,0.10);
      --text:#f4f4ff;
      --muted:#96a2cc;
      --a:#ff3df7;
      --b:#2af5ff;
      --ok:#2afa9b;
      --bad:#ff4b6b;
      --warn:#ffd36a;
      --r:22px;
      --shadow: 0 20px 55px rgba(0,0,0,.65);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:
        radial-gradient(circle at 0% 0%, #1a1037 0, #050712 40%, #000 100%);
      color:var(--text);
      font-family:var(--sans);
      overflow-x:hidden;
    }

    /* ===== Animation: floating neon blobs (light + tasty) ===== */
    .blobs{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      filter: blur(35px);
      opacity:.55;
    }
    .blob{
      position:absolute; width:380px; height:380px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,61,247,.7), rgba(255,61,247,0) 60%);
      animation: floaty 16s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    .blob.b{
      width:420px; height:420px;
      background: radial-gradient(circle at 30% 30%, rgba(42,245,255,.55), rgba(42,245,255,0) 60%);
      animation-duration: 19s;
      animation-delay: -4s;
    }
    .blob.c{
      width:300px; height:300px;
      background: radial-gradient(circle at 30% 30%, rgba(255,211,106,.45), rgba(255,211,106,0) 60%);
      animation-duration: 21s;
      animation-delay: -9s;
    }
    @keyframes floaty{
      0%   { transform: translate(-40px, -20px) scale(1); }
      35%  { transform: translate(120px, 70px) scale(1.08); }
      70%  { transform: translate(-10px, 140px) scale(0.95); }
      100% { transform: translate(-40px, -20px) scale(1); }
    }

    /* Subtle scanline animation */
    .scanline{
      position:fixed; inset:0; pointer-events:none; z-index:1;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.03) 0px,
          rgba(255,255,255,0.03) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      opacity:.14;
      animation: scan 6.5s linear infinite;
      mix-blend-mode: soft-light;
    }
    @keyframes scan{
      0%{transform:translateY(-14px)}
      100%{transform:translateY(14px)}
    }

    .shell{max-width:1200px;margin:16px auto;padding:16px;position:relative;z-index:2}
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--border);border-radius:30px;
      background:
        radial-gradient(circle at 0 0, rgba(255, 61, 247, 0.12), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(42, 245, 255, 0.14), transparent 55%),
        linear-gradient(135deg, rgba(10, 12, 28, 0.96), rgba(2, 4, 16, 0.98));
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    /* tiny shimmer on header */
    .header::after{
      content:"";
      position:absolute; inset:-60%;
      background: linear-gradient(90deg, transparent 40%, rgba(255,255,255,.08) 50%, transparent 60%);
      transform: rotate(18deg) translateX(-40%);
      animation: shimmer 7.5s ease-in-out infinite;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    @keyframes shimmer{
      0%{ transform: rotate(18deg) translateX(-60%); opacity:.0 }
      25%{ opacity:.25 }
      50%{ transform: rotate(18deg) translateX(60%); opacity:.0 }
      100%{ transform: rotate(18deg) translateX(60%); opacity:.0 }
    }

    .title{
      font-weight:900;letter-spacing:.10em;text-transform:uppercase;
      background: linear-gradient(120deg, #ff9bf7 0%, #ffffff 30%, #2af5ff 60%, #ffef9f 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow:0 0 10px rgba(255,61,247,.8), 0 0 20px rgba(42,245,255,.7);
    }
    .sub{color:var(--muted);font-size:.82rem;letter-spacing:.18em;text-transform:uppercase;margin-top:4px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .pill{
      padding:7px 12px;border-radius:999px;border:1px solid var(--border);
      color:var(--muted);background:rgba(0,0,0,.35);
      font-family:var(--mono); font-size:.86rem;
      max-width:min(520px, 70vw);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .status{
      padding:7px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(0,0,0,.35); font-size:.86rem;
      display:flex;align-items:center;gap:8px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--warn); box-shadow:0 0 12px rgba(255,211,106,.75);
    }
    .dot.ok{background:var(--ok); box-shadow:0 0 12px rgba(42,250,155,.7)}
    .dot.bad{background:var(--bad); box-shadow:0 0 12px rgba(255,75,107,.7)}
    .dot.warn{background:var(--warn); box-shadow:0 0 12px rgba(255,211,106,.75)}

    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border-radius:var(--r);border:1px solid var(--border);
      background:var(--panel);box-shadow:0 12px 34px rgba(0,0,0,.45);
      padding:14px; position:relative; overflow:hidden;
    }
    .card::before{
      content:"";position:absolute;inset:-40%;
      background: radial-gradient(circle at 0 0, rgba(255, 61, 247, 0.09), transparent 55%);
      pointer-events:none;
    }
    .card h2{
      font-size:.95rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);
      margin-bottom:10px
    }

    label{display:block;color:var(--muted);font-size:.85rem;margin:8px 0 4px}
    input, select{
      width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(3,5,18,.9);color:var(--text);outline:none;
      font-family:var(--sans);
    }
    input:focus, select:focus{
      border-color:rgba(255,61,247,.8); box-shadow:0 0 0 1px rgba(42,245,255,.6)
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.row{grid-template-columns:1fr}}

    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      cursor:pointer;border:none;border-radius:999px;
      padding:10px 14px;font-weight:900;letter-spacing:.14em;text-transform:uppercase;
      background: linear-gradient(120deg, #ff3df7, #ff9bf7, #2af5ff);
      color:#050712; box-shadow:0 0 12px rgba(255,61,247,.7);
      transition:.16s ease;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 0 18px rgba(255,61,247,.9)}
    .btn.secondary{
      background:rgba(0,0,0,.35); color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    .btn.secondary:hover{transform:translateY(-1px); box-shadow:0 0 12px rgba(42,245,255,.35)}

    .result{
      margin-top:12px; padding:12px; border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      transform: translateY(8px); opacity:0;
      transition: .26s ease;
    }
    .result.show{transform:translateY(0); opacity:1}

    /* pulse glow on update */
    .glow{ animation: glow .7s ease; }
    @keyframes glow{
      0%{box-shadow:0 0 0 rgba(255,61,247,0)}
      55%{box-shadow:0 0 28px rgba(255,61,247,.55)}
      100%{box-shadow:0 0 0 rgba(255,61,247,0)}
    }

    /* tiny spinner for loading */
    .spin{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(255,255,255,.22);
      border-top-color: rgba(42,245,255,.9);
      animation: spin 0.9s linear infinite;
      display:inline-block;
      box-shadow: 0 0 12px rgba(42,245,255,.25);
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }

    .k{color:var(--muted);font-size:.92rem}
    .mono{font-family:var(--mono)}
    .ok{color:var(--ok);font-weight:800}
    .bad{color:var(--bad);font-weight:800}
    .warn{color:var(--warn);font-weight:800}
    hr{border:none;border-top:1px solid rgba(255,255,255,.10);margin:10px 0}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--muted);
      font-size:.82rem;
      font-family:var(--mono);
      cursor:pointer;
      transition: .14s ease;
    }
    .chip:hover{ transform: translateY(-1px); border-color: rgba(42,245,255,.25); color: var(--text); }

    .crypto-grid{display:grid;grid-template-columns: 1fr;gap:10px;margin-top:10px}
    .crypto-item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      border-radius:16px;
      padding:10px;
      transition:.16s ease;
    }
    .crypto-item:hover{transform:translateY(-1px); border-color:rgba(42,245,255,.25)}
    .crypto-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .crypto-id{font-weight:900;letter-spacing:.08em;text-transform:uppercase}
    .crypto-metrics{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .tag{font-family:var(--mono); font-size:.84rem; color:var(--muted)}

    .checklist{
      margin-top:8px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      padding:10px;
      max-height:210px;
      overflow:auto;
    }
    .check{display:flex;align-items:center;gap:10px;padding:6px 6px;border-radius:12px}
    .check:hover{background:rgba(255,255,255,.04)}
    .check input{width:auto}
    .small{font-size:.85rem;color:var(--muted);margin-top:8px}

    /* calendar panel */
    .calendar-head{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .mini{
      padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(3,5,18,.85);color:var(--text);outline:none;
      font-family:var(--mono);
      max-width:240px;
    }
  </style>
</head>

<body>
  <div class="blobs">
    <div class="blob" style="left:-120px; top:-120px;"></div>
    <div class="blob b" style="right:-160px; top:-140px;"></div>
    <div class="blob c" style="left:20%; bottom:-180px;"></div>
  </div>
  <div class="scanline"></div>

  <div class="shell">
    <div class="header">
      <div>
        <div class="title">Oracle by J√©j√®</div>
        <div class="sub">FOOT ‚Ä¢ CRYPTO ‚Ä¢ EDGE MACHINE</div>
      </div>
      <div class="right">
        <div class="status" title="√âtat du backend (Render peut √™tre lent au 1er appel)">
          <span class="dot warn" id="dot"></span>
          <span class="mono" id="statusText">wake‚Ä¶</span>
        </div>
        <div class="pill" id="apiPill">API: ‚Ä¶</div>
      </div>
    </div>

    <div class="grid">
      <!-- FOOT -->
      <div class="card">
        <h2>‚öΩ Foot ‚Äî Predict + Value Bet</h2>

        <div class="row">
          <div>
            <label>Ligue</label>
            <select id="league">
              <option value="ligue1">ligue1</option>
              <option value="premier_league" disabled>premier_league (bient√¥t)</option>
              <option value="la_liga" disabled>la_liga (bient√¥t)</option>
              <option value="serie_a" disabled>serie_a (bient√¥t)</option>
              <option value="bundesliga" disabled>bundesliga (bient√¥t)</option>
            </select>
          </div>
          <div>
            <label>Mode</label>
            <select id="mode">
              <option value="predict">predict (probas)</option>
              <option value="value">value (avec cotes)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Home</label>
            <input id="home" list="teams" value="AS MONACO" placeholder="ex: AS MONACO" />
          </div>
          <div>
            <label>Away</label>
            <input id="away" list="teams" value="LOSC LILLE" placeholder="ex: LOSC LILLE" />
          </div>
        </div>

        <datalist id="teams"></datalist>

        <div class="row">
          <div>
            <label>Odd Home</label>
            <input id="odd_home" value="2.10" inputmode="decimal" />
          </div>
          <div>
            <label>Odd Draw</label>
            <input id="odd_draw" value="3.25" inputmode="decimal" />
          </div>
        </div>

        <label>Odd Away</label>
        <input id="odd_away" value="3.60" inputmode="decimal" />

        <div class="btnbar">
          <button class="btn" id="btnFoot"><span>Calculer</span></button>
          <button class="btn secondary" id="btnSwap">Swap</button>
          <button class="btn secondary" id="btnRandom">Roue üé°</button>
          <button class="btn secondary" id="btnCalendar">Calendrier üìÖ</button>
          <button class="btn secondary" id="btnWake">Wake API</button>
        </div>

        <div class="chips">
          <div class="chip" title="endpoint">/api/foot/predict</div>
          <div class="chip" title="endpoint">/api/foot/value</div>
          <div class="chip" title="endpoint">/api/foot/calendar_real</div>
        </div>

        <div class="result" id="footResult"></div>

        <!-- Calendar panel -->
        <div class="result" id="calResult"></div>

        <div class="small">
          Astuce : Render peut √™tre lent au premier appel. ‚ÄúWake API‚Äù r√©veille le backend.
        </div>
      </div>

      <!-- CRYPTO -->
      <div class="card">
        <h2>ü™ô Crypto ‚Äî Scanner</h2>

        <div class="row">
          <div>
            <label>Nombre max</label>
            <input id="limit" value="20" inputmode="numeric" />
          </div>
          <div>
            <label>Tri</label>
            <select id="sort">
              <option value="score">score</option>
              <option value="chg">variation 24h</option>
              <option value="id">nom</option>
            </select>
          </div>
        </div>

        <label>S√©lection coins (cases)</label>
        <div class="checklist" id="coinChecks"></div>

        <div class="btnbar">
          <button class="btn" id="btnCrypto"><span>Scanner</span></button>
          <button class="btn secondary" id="btnSelectAll">Tout</button>
          <button class="btn secondary" id="btnSelectNone">Rien</button>
        </div>

        <div class="chips">
          <div class="chip">/api/crypto/scan</div>
        </div>

        <div class="result" id="cryptoResult"></div>
        <div class="small">Note : le backend renvoie un top (score simple). Ici on filtre/tri c√¥t√© front pour un rendu pro.</div>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // CONFIG
    // ==========================
    const BACKEND_URL = "https://oracle-jeje-backend.onrender.com"; // <-- ton URL Render
    document.getElementById("apiPill").textContent = "API: " + BACKEND_URL;

    // ==========================
    // Helpers UI
    // ==========================
    const dot = document.getElementById("dot");
    const statusText = document.getElementById("statusText");
    const footResult = document.getElementById("footResult");
    const calResult = document.getElementById("calResult");
    const cryptoResult = document.getElementById("cryptoResult");

    function setStatus(state, text){
      statusText.textContent = text;
      dot.classList.remove("ok","bad","warn");
      if(state === "ok") dot.classList.add("ok");
      else if(state === "bad") dot.classList.add("bad");
      else dot.classList.add("warn");
    }

    function showResult(el, html){
      el.innerHTML = html;
      el.classList.add("show");
      el.classList.add("glow");
      setTimeout(()=> el.classList.remove("glow"), 750);
    }

    function pct(x){ return (x * 100).toFixed(1) + "%"; }
    function esc(s){ return String(s).replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    // fetch with timeout + friendly errors
    async function fetchJSON(url, {timeoutMs=25000, retries=1} = {}){
      for(let attempt=0; attempt<=retries; attempt++){
        const controller = new AbortController();
        const t = setTimeout(()=> controller.abort(), timeoutMs);
        try{
          const res = await fetch(url, {signal: controller.signal});
          clearTimeout(t);
          const data = await res.json().catch(()=> ({}));
          if(!res.ok) throw new Error(JSON.stringify(data));
          return data;
        }catch(e){
          clearTimeout(t);
          const isAbort = String(e).includes("AbortError");
          if(attempt < retries){
            await new Promise(r => setTimeout(r, 900));
            continue;
          }
          if(isAbort) throw new Error("timeout");
          throw e;
        }
      }
    }

    // ==========================
    // Backend wake / health
    // ==========================
    async function wakeBackend(){
      setStatus("warn", "waking‚Ä¶");
      try{
        const data = await fetchJSON(`${BACKEND_URL}/health`, {timeoutMs: 25000, retries: 1});
        if(data && data.status === "ok"){
          setStatus("ok", "online");
          return true;
        }
        setStatus("bad", "weird");
        return false;
      }catch(e){
        if(String(e.message) === "timeout"){
          setStatus("bad", "cold start");
        }else{
          setStatus("bad", "offline");
        }
        return false;
      }
    }
    wakeBackend();
    document.getElementById("btnWake").addEventListener("click", wakeBackend);

    // ==========================
    // Teams datalist
    // ==========================
    let _teamsCache = [];

    async function loadTeams(){
      try{
        const league = document.getElementById("league").value.trim();
        const url = `${BACKEND_URL}/api/foot/teams?league=${encodeURIComponent(league)}`;
        const data = await fetchJSON(url, {timeoutMs: 15000, retries: 1});
        const dl = document.getElementById("teams");
        _teamsCache = (data.teams || []);
        dl.innerHTML = _teamsCache.map(t => `<option value="${esc(t)}"></option>`).join("");
      }catch(e){
        // si √ßa rate, on garde ce qu'on a
      }
    }
    loadTeams();
    document.getElementById("league").addEventListener("change", loadTeams);

    // ==========================
    // FOOT
    // ==========================
    document.getElementById("btnSwap").addEventListener("click", () => {
      const h = document.getElementById("home");
      const a = document.getElementById("away");
      const tmp = h.value; h.value = a.value; a.value = tmp;
    });

    document.getElementById("btnFoot").addEventListener("click", async () => {
      const league = document.getElementById("league").value.trim();
      const mode = document.getElementById("mode").value;
      const home = document.getElementById("home").value.trim();
      const away = document.getElementById("away").value.trim();

      const odd_home = document.getElementById("odd_home").value.trim();
      const odd_draw = document.getElementById("odd_draw").value.trim();
      const odd_away = document.getElementById("odd_away").value.trim();

      if(!home || !away){
        showResult(footResult, `<div class="bad">Home/Away manquants.</div>`);
        return;
      }

      showResult(footResult, `<div class="k"><span class="spin"></span> Calcul en cours‚Ä¶</div>`);

      try{
        const pUrl = `${BACKEND_URL}/api/foot/predict?league=${encodeURIComponent(league)}&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}`;
        const pred = await fetchJSON(pUrl, {timeoutMs: 25000, retries: 1});
        setStatus("ok", "online");

        const c = pred.consensus;
        const topScores = (pred.top_scores || [])
          .slice(0,6)
          .map(s => `${esc(s.score)} (${(s.prob*100).toFixed(1)}%)`)
          .join(" ¬∑ ");

        let valueBlock = `<div class="k">Mode: <b>predict</b> (pas de calcul value)</div>`;

        if(mode === "value"){
          const vUrl = `${BACKEND_URL}/api/foot/value?league=${encodeURIComponent(league)}&home=${encodeURIComponent(home)}&away=${encodeURIComponent(away)}&odd_home=${encodeURIComponent(odd_home)}&odd_draw=${encodeURIComponent(odd_draw)}&odd_away=${encodeURIComponent(odd_away)}`;
          const full = await fetchJSON(vUrl, {timeoutMs: 25000, retries: 1});
          const best = full.value_bet?.best;

          if(best){
            valueBlock = `
              <div class="k">Best value: <span class="${best.is_value ? 'ok':'warn'}">${esc(best.outcome).toUpperCase()}</span>
                ‚Äî edge ${(best.edge*100).toFixed(2)}%
                ‚Äî kelly ${(best.kelly*100).toFixed(2)}%
              </div>
              <div class="k mono">Cotes: H ${esc(odd_home)} ¬∑ N ${esc(odd_draw)} ¬∑ A ${esc(odd_away)}</div>
            `;
          }else{
            valueBlock = `<div class="warn">Value bet non dispo (r√©ponse backend inattendue).</div>`;
          }
        }

        showResult(footResult, `
          <div class="mono"><b>${esc(pred.home)}</b> vs <b>${esc(pred.away)}</b> <span class="k">(${esc(pred.league)})</span></div>
          <div class="k">Consensus: <b>H</b> ${pct(c.p_home)} ¬∑ <b>N</b> ${pct(c.p_draw)} ¬∑ <b>A</b> ${pct(c.p_away)}</div>
          <div class="k">Top scores: ${topScores || "‚Äî"}</div>
          <hr>
          ${valueBlock}
        `);

      }catch(e){
        if(String(e.message) === "timeout"){
          setStatus("bad", "cold start");
          showResult(footResult, `
            <div class="bad">Backend trop long √† r√©pondre (Render cold start).</div>
            <div class="k">Clique ‚ÄúWake API‚Äù, attends 5‚Äì15s, puis relance.</div>
          `);
        }else{
          setStatus("bad", "error");
          showResult(footResult, `<div class="bad">Erreur foot</div><div class="k mono">${esc(e)}</div>`);
        }
      }
    });

    // ==========================
    // FOOT - Roue match (random)
    // ==========================
    document.getElementById("btnRandom").addEventListener("click", async () => {
      const league = document.getElementById("league").value.trim();

      showResult(footResult, `<div class="k"><span class="spin"></span> Tirage match‚Ä¶</div>`);

      // 1) tente endpoint backend (si tu l'as ajout√©)
      try{
        const data = await fetchJSON(`${BACKEND_URL}/api/foot/random_match?league=${encodeURIComponent(league)}`, {timeoutMs: 15000, retries: 0});
        if(data && data.home && data.away){
          document.getElementById("home").value = data.home;
          document.getElementById("away").value = data.away;
          showResult(footResult, `<div class="k">üé° Tirage: <b class="mono">${esc(data.home)}</b> vs <b class="mono">${esc(data.away)}</b></div>`);
          return;
        }
      }catch(e){
        // ignore -> fallback front
      }

      // 2) fallback : random depuis la liste teams charg√©e
      const teams = (_teamsCache || []).slice();
      if(teams.length < 2){
        showResult(footResult, `<div class="bad">Pas assez d‚Äô√©quipes charg√©es. Clique ‚ÄúWake API‚Äù, change de ligue puis reviens sur ligue1.</div>`);
        return;
      }
      const pick = () => teams[Math.floor(Math.random() * teams.length)];
      let home = pick(), away = pick();
      let guard = 0;
      while(home === away && guard < 20){ away = pick(); guard++; }

      document.getElementById("home").value = home;
      document.getElementById("away").value = away;
      showResult(footResult, `<div class="k">üé° Tirage (fallback): <b class="mono">${esc(home)}</b> vs <b class="mono">${esc(away)}</b></div>`);
    });

    // ==========================
    // FOOT - Calendrier officiel
    // ==========================
    let _calendar = null; // { rounds: { "1": [ {date,home,away}, ...], ... } }

    function renderCalendar(roundNumber){
      if(!_calendar || !_calendar.rounds) return;

      const rounds = _calendar.rounds;
      const keys = Object.keys(rounds).map(x => parseInt(x,10)).sort((a,b)=>a-b);

      const current = String(roundNumber || keys[0] || 1);
      const matches = rounds[current] || [];

      const head = `
        <div class="calendar-head">
          <div class="k">üìÖ Calendrier officiel Ligue 1 (saison)</div>
          <select class="mini" id="roundPick">
            ${keys.map(k => `<option value="${k}" ${String(k)===current ? "selected":""}>Journ√©e ${k}</option>`).join("")}
          </select>
          <span class="k mono">(${matches.length} matchs)</span>
        </div>
        <div class="small">Clique un match ‚Üí √ßa remplit Home/Away automatiquement.</div>
      `;

      const list = matches.map(m => {
        const label = `${m.home} vs ${m.away}`;
        return `<div class="chip" data-h="${esc(m.home)}" data-a="${esc(m.away)}">${esc(m.date)} ¬∑ ${esc(label)}</div>`;
      }).join("");

      showResult(calResult, head + `<div class="chips">${list || `<div class="warn">Aucun match trouv√©.</div>`}</div>`);

      const pick = document.getElementById("roundPick");
      if(pick){
        pick.addEventListener("change", () => renderCalendar(parseInt(pick.value,10)));
      }

      calResult.querySelectorAll("[data-h]").forEach(el => {
        el.addEventListener("click", () => {
          document.getElementById("home").value = el.getAttribute("data-h");
          document.getElementById("away").value = el.getAttribute("data-a");
        });
      });
    }

    document.getElementById("btnCalendar").addEventListener("click", async () => {
      showResult(calResult, `<div class="k"><span class="spin"></span> Chargement calendrier‚Ä¶</div>`);
      try{
        const data = await fetchJSON(`${BACKEND_URL}/api/foot/calendar_real`, {timeoutMs: 25000, retries: 1});
        if(data && data.error){
          showResult(calResult, `<div class="bad">Calendrier: ${esc(data.error)}</div><div class="k mono">${esc(data.detail || "‚Äî")}</div>`);
          return;
        }
        _calendar = data;
        renderCalendar(1);
      }catch(e){
        showResult(calResult, `<div class="bad">Erreur calendrier</div><div class="k mono">${esc(e)}</div>`);
      }
    });

    // ==========================
    // CRYPTO (checkboxes + filter)
    // ==========================
    const DEFAULT_COINS = [
      "bitcoin","ethereum","solana","bnb","ripple",
      "cardano","avalanche-2","chainlink","polkadot","matic-network",
      "near","arbitrum","optimism","injective-protocol","render-token",
      "aptos","sei-network","cosmos","the-open-network","tron"
    ];

    const coinChecks = document.getElementById("coinChecks");

    function renderCoinChecks(){
      coinChecks.innerHTML = DEFAULT_COINS.map(id => `
        <label class="check">
          <input type="checkbox" data-coin="${id}" checked />
          <span class="mono">${id}</span>
        </label>
      `).join("");
    }
    renderCoinChecks();

    function getSelectedCoins(){
      const boxes = [...coinChecks.querySelectorAll("input[type=checkbox]")];
      return boxes.filter(b => b.checked).map(b => b.getAttribute("data-coin"));
    }

    document.getElementById("btnSelectAll").addEventListener("click", () => {
      [...coinChecks.querySelectorAll("input[type=checkbox]")].forEach(b => b.checked = true);
    });
    document.getElementById("btnSelectNone").addEventListener("click", () => {
      [...coinChecks.querySelectorAll("input[type=checkbox]")].forEach(b => b.checked = false);
    });

    document.getElementById("btnCrypto").addEventListener("click", async () => {
      const limitRaw = document.getElementById("limit").value.trim() || "20";
      const limit = Math.max(5, Math.min(30, parseInt(limitRaw, 10) || 20));
      const sortMode = document.getElementById("sort").value;
      const selected = getSelectedCoins();

      if(selected.length === 0){
        showResult(cryptoResult, `<div class="bad">Aucun coin s√©lectionn√©.</div>`);
        return;
      }

      showResult(cryptoResult, `<div class="k"><span class="spin"></span> Scan crypto‚Ä¶</div>`);

      try{
        const url = `${BACKEND_URL}/api/crypto/scan?limit=${encodeURIComponent(30)}`;
        const data = await fetchJSON(url, {timeoutMs: 25000, retries: 1});
        setStatus("ok", "online");

        // ‚úÖ gestion propre des erreurs backend
        if(data && data.error){
          showResult(cryptoResult, `
            <div class="bad">Crypto: ${esc(data.error)}</div>
            <div class="k mono">${esc(data.detail || "‚Äî")}</div>
            <div class="small">Cause fr√©quente: CoinGecko rate-limit (429) ou souci r√©seau. Ton backend devrait cache/fallback si tu as mis la version robuste.</div>
          `);
          return;
        }

        const fg = data.fear_greed || {};
        let list = (data.top || [])
          .filter(c => selected.includes(c.id))
          .slice(0, limit);

        if(sortMode === "chg"){
          list.sort((a,b) => (b.chg_24h||0) - (a.chg_24h||0));
        }else if(sortMode === "id"){
          list.sort((a,b) => String(a.id).localeCompare(String(b.id)));
        }else{
          list.sort((a,b) => (b.score||0) - (a.score||0));
        }

        const cachedTag = data.cached ? `<span class="warn mono">cached</span>` : `<span class="ok mono">live</span>`;
        const warnTag = data.warning ? `<span class="warn mono">${esc(data.warning)}</span>` : "";

        const items = list.map(c => {
          const chg = Number(c.chg_24h || 0);
          const chgClass = chg >= 0 ? "ok" : "bad";
          const price = (c.price_usd !== undefined && c.price_usd !== null) ? `$${Number(c.price_usd).toLocaleString("en-US", {maximumFractionDigits: 8})}` : "‚Äî";

          return `
            <div class="crypto-item">
              <div class="crypto-top">
                <div class="crypto-id mono">${esc(c.id)}</div>
                <div class="tag mono">score ${esc(c.score)}</div>
              </div>
              <div class="crypto-metrics">
                <div class="tag mono">prix ${price}</div>
                <div class="tag mono ${chgClass}">24h ${chg.toFixed(2)}%</div>
              </div>
            </div>
          `;
        }).join("");

        showResult(cryptoResult, `
          <div class="k">Fear & Greed: <b>${esc(fg.value ?? "‚Äî")}</b> <span class="mono">(${esc(fg.value_classification ?? "‚Äî")})</span> ¬∑ ${cachedTag} ${warnTag}</div>
          <hr>
          <div class="crypto-grid">${items || `<div class="warn">Aucun r√©sultat apr√®s filtre.</div>`}</div>
        `);

      }catch(e){
        if(String(e.message) === "timeout"){
          setStatus("bad", "cold start");
          showResult(cryptoResult, `
            <div class="bad">Backend trop long √† r√©pondre (Render cold start).</div>
            <div class="k">Clique ‚ÄúWake API‚Äù, attends 5‚Äì15s, puis relance.</div>
          `);
        }else{
          setStatus("bad", "error");
          showResult(cryptoResult, `<div class="bad">Erreur crypto</div><div class="k mono">${esc(e)}</div>`);
        }
      }
    });
  </script>
</body>
</html>